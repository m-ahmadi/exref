<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot/dist/uPlot.min.css">
<script src="https://cdn.jsdelivr.net/npm/uplot/dist/uPlot.iife.min.js"></script>

<div id="charts"></div>

<script src="./fn.js"></script>
<script>
var data = [
 -0.60207, -0.85543,  0.4084,   0.60292,
	0.14554, -0.11812, -0.22425, -0.25985,
 -0.26579,  0.70213,  0.32766,  0.55666,
	0.50528,  0.62256,  0.21262,  0.36577,
	0.85273,  1.0159,   0.53494,  1.4023,
];
var rn = (n,x) => Math.floor(Math.random()*(x-n)+n);

//data = [...Array(20)].map(()=>rn(-250,250))
/*data=[300];
for (let i=1; i<80; i++) {
	var p=data[i-1], d=p*0.05, v=rn(p-d, p+d), k=2;
	while (v===p) {v=rn(p-d, p+d*k); k*=2;}
	data.push(v);
}*/

var u = mean(data);
var s = stdv(data);
var ucl = u + (s * 1.5);
var lcl = u + (s * -1.5);
var cma = data.map((v,i,a)=> mean(a.slice(0,i+1)) );

var o = {points:{show:false},width:2,};
var O = {points:{show:false},dash:[20],width:2};

new uPlot({
	width:800, height:400,
	series: [
		{label:'i'},
		{label:'x', stroke:'black',points:{size:8,fill:'black'}},
		{label:'XÌ…', stroke:'lime',...o},
		{label:'UCL', stroke:'blue',...O},
		{label:'LCL', stroke:'red',...O},
		{label:'cma', stroke:'magenta',width:2,points:{size:6,fill:'magenta'}},
	],
	scales: {x:{time:false}},
	axes: [{grid:{show:false}}, {grid:{show:false}}]
}, [
	[...data.keys()].map(i=>i+1),
	data,
	data.map(()=>u),
	data.map(()=>ucl),
	data.map(()=>lcl),
	cma,
], charts);



var up = data.map(i=> (i=i-u, i<0?0:i));
var dw = data.map(i=> (i=i-u, i>0?0:i));
var all = up.map((v,i)=> v===0 ? dw[i] : v);

var ucl2 = mean(all) + (stdv(all) * 1.5);
var lcl2 = mean(all) - (stdv(all) * 1.5);

new uPlot({
	width:800, height:400,
	series: [
		{label:'i'},
		//{label:'x',stroke:'black',width:2,points:{show:false}},
		{label:'+ cusum', stroke:'limegreen',width:3,points:{size:8,fill:'limegreen'}},
		{label:'- cusum', stroke:'crimson',width:3,points:{size:8,fill:'crimson'}},
		{label:'UCL', stroke:'blue',...o,dash:[5]},
		{label:'LCL', stroke:'red',...o,dash:[5]},
	],
	scales: {x:{time:false}},
	axes: [{grid:{show:false}}]
}, [
	[...data.keys()].map(i=>i+1),
	//data,
	up,
	dw,
	all.map(()=>ucl2),
	all.map(()=>lcl2),
], charts);

</script>